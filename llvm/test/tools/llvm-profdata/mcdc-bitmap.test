# Test MC/DC bitmap reading and merging.

# Merge as profdata.
RUN: llvm-profdata merge %p/Inputs/mcdc-1.proftext %p/Inputs/mcdc-2.proftext -o %t.profdata
RUN: llvm-profdata show %t.profdata --text -all-functions | FileCheck %s --check-prefix=MCDC
# Merge as proftext.
RUN: llvm-profdata merge %p/Inputs/mcdc-1.proftext %p/Inputs/mcdc-2.proftext -o %t.proftext
RUN: llvm-profdata show %t.proftext --text -all-functions | FileCheck %s --check-prefix=MCDC

MCDC: # Num Bitmap Bytes:
MCDC-NEXT: $1
MCDC-NEXT: # Bitmap Byte Values:
MCDC-NEXT: a
MCDC: # Num Bitmap Bytes:
MCDC-NEXT: $2
MCDC-NEXT: # Bitmap Byte Values:
MCDC-NEXT: 0x29
MCDC-NEXT: 0x0

# Merge as profdata.
RUN: llvm-profdata merge %p/Inputs/mcdc-3.proftext %p/Inputs/mcdc-4.proftext -o %t.profdata
RUN: llvm-profdata show %t.profdata --text -all-functions | FileCheck %s --check-prefix=MCDC2
# Merge as proftext.
RUN: llvm-profdata merge %p/Inputs/mcdc-3.proftext %p/Inputs/mcdc-4.proftext -o %t.proftext
RUN: llvm-profdata show %t.proftext --text -all-functions | FileCheck %s --check-prefix=MCDC2

MCDC2: # Num Bitmap Bytes:
MCDC2-NEXT: $8
MCDC2-NEXT: # Bitmap Byte Values:
MCDC2-NEXT: 0x1
MCDC2-NEXT: 0x2
MCDC2-NEXT: 0x3
MCDC2-NEXT: 0xf
MCDC2-NEXT: 0xf
MCDC2-NEXT: 0xe
MCDC2-NEXT: 0xf
MCDC2-NEXT: 0xa

# Incompatible size mismatch.
RUN: llvm-profdata merge %p/Inputs/mcdc-2.proftext %p/Inputs/mcdc-4.proftext -o %t.profdata 2>&1 | FileCheck %s --check-prefix=MCDC3
# Merge as proftext
RUN: llvm-profdata merge %p/Inputs/mcdc-2.proftext %p/Inputs/mcdc-4.proftext -o %t.proftext 2>&1 | FileCheck %s --check-prefix=MCDC3

MCDC3: function bitmap size change detected (bitmap size mismatch)

# Invalid number of bitmap bytes.
RUN: not llvm-profdata merge %p/Inputs/mcdc-3.proftext %p/Inputs/mcdc-err0.proftext -o %t.proftext 2>&1 | FileCheck %s --check-prefix=MCDC4

MCDC4: malformed instrumentation profile data: number of bitmap bytes is not a valid integer

# Invalid bitmap byte.
RUN: not llvm-profdata merge %p/Inputs/mcdc-3.proftext %p/Inputs/mcdc-err1.proftext -o %t.proftext 2>&1 | FileCheck %s --check-prefix=MCDC5

MCDC5: malformed instrumentation profile data: bitmap byte is invalid
